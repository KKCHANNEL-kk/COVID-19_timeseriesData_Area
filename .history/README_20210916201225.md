# COVID-19_timeseriesData_Area——新冠疫情地市级时间序列数据采集
* 1. [简介](#)
* 2. [使用说明](#-1)
* 3. [实现原理](#-1)
	* 3.1. [数据获取](#-1)
	* 3.2. [数据清洗](#-1)
* 4. [后续挖坑](#-1)

##  1. <a name=''></a>1.简介
实验室近期需要采集地市级的疫情数据。目前能找到的大部分数据源是**省级粒度的时间序列数据**或**地市级的实时截面数据**，起初找到了这个项目

**2019新型冠状病毒疫情实时爬虫**<a>https://github.com/BlankerL/DXY-COVID-19-Crawler 

使用了丁香园的数据。但是发现了丁香园数据中的几个问题：
1. 统计口径较混乱，同一地级市在不同的时间指向不同的字段名；
2. 部分省（广东、四川、吉林、甘肃）没有单独统计境外输入数据，境外输入被归于各地级市中，该部分数据无法清洗；
3. 部分数据在新时间中被修正，没有同步修正回旧时间，出现累计确诊数倒减的情况。

受问题2影响，最后还是找新数据源重新采集并清洗一遍数据。本项目使用腾讯新闻api获取并处理新冠疫情地市级时间序列数据，数据所有权为腾讯新闻，脚本及获取数据仅作参考与学习用，对数据质量不做担保。本人无法授权任何个人或团体在科研或商业项目中使用本数据，如有需要，希望您能够联系腾讯新闻并取得许可。如有建议或异常反馈，欢迎提交issue。

腾讯新闻疫情实时追踪页面：<a>https://news.qq.com/zt2020/page/feiyan.htm#/global

祝愿大家一切都好！

##  2. <a name='-1'></a>2.使用说明
下载文件。保证getAreaData.py和covid19_area_timeseries_data.py在同一路径下，运行covid19_area_timeseries_data.py即可

##  3. <a name='-1'></a>3.实现原理
###  3.1. <a name='-1'></a>数据获取
打开网页后开启浏览器的开发者工具，选中Network查看网页传输的文件，就可以比较顺利地找到腾讯的api，写了一个很简单的请求就抓齐了数据（见getAreaData.py）。

![找到api的位置](https://github.com/KKCHANNEL-kk/Vscodeworkplace/blob/master/COVID-19_timeseriesData_Area_%E6%96%B0%E5%86%A0%E7%96%AB%E6%83%85%E5%9C%B0%E5%B8%82%E7%BA%A7%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE/mdpics/%E8%85%BE%E8%AE%AF%E6%96%B0%E9%97%BB%E7%96%AB%E6%83%85%E6%95%B0%E6%8D%AE%E6%88%AA%E5%9B%BE.png)

返回的json中时间序列不齐，只包含卫健委公布实时新闻当天的更新数据，因此在两次时间中的空缺数据需要我自行填补（两次公告之前的数据理论上不变，取时间靠前的数据填补缺失值）

![json截图](https://github.com/KKCHANNEL-kk/Vscodeworkplace/blob/master/COVID-19_timeseriesData_Area_%E6%96%B0%E5%86%A0%E7%96%AB%E6%83%85%E5%9C%B0%E5%B8%82%E7%BA%A7%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE/mdpics/json%E6%88%AA%E5%9B%BE.png)

api需要的参数是省份province和城市（直辖市的区）city，api的制作使用了一个睿智办法肉身编码。需要注意港澳台只有province没有city参数，所以另开了一个循环单独处理。地名字典不是完整字典，有部分是从百度疫情信息扒下来的，会有几个无确诊的地级市获取不到数据，视为"截至当前时间确诊为0"处理。

![肉身编码小朋友不要学，牺牲我一个就好](https://github.com/KKCHANNEL-kk/Vscodeworkplace/blob/master/COVID-19_timeseriesData_Area_%E6%96%B0%E5%86%A0%E7%96%AB%E6%83%85%E5%9C%B0%E5%B8%82%E7%BA%A7%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE/mdpics/%E8%82%89%E8%BA%AB%E7%BC%96%E7%A0%81.png)

api请求和json解析使用的基本都是封装好的方法，略。

###  3.2. <a name='-1'></a>数据清洗
先观察一下原数据
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>province</th>
      <th>city</th>
      <th>y</th>
      <th>date</th>
      <th>confirm</th>
      <th>dead</th>
      <th>heal</th>
      <th>suspect</th>
      <th>confirm_add</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>广东</td>
      <td>广州</td>
      <td>2020</td>
      <td>01.28</td>
      <td>51</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>广东</td>
      <td>广州</td>
      <td>2020</td>
      <td>01.29</td>
      <td>63</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>广东</td>
      <td>广州</td>
      <td>2020</td>
      <td>01.30</td>
      <td>94</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>广东</td>
      <td>广州</td>
      <td>2020</td>
      <td>01.31</td>
      <td>112</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>广东</td>
      <td>广州</td>
      <td>2020</td>
      <td>02.01</td>
      <td>150</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>34526</th>
      <td>34526</td>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021</td>
      <td>09.11</td>
      <td>16074</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>NaN</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>34527</th>
      <td>34527</td>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021</td>
      <td>09.12</td>
      <td>16088</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>NaN</td>
      <td>14.0</td>
    </tr>
    <tr>
      <th>34528</th>
      <td>34528</td>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021</td>
      <td>09.13</td>
      <td>16093</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>NaN</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>34529</th>
      <td>34529</td>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021</td>
      <td>09.14</td>
      <td>16098</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>NaN</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>34530</th>
      <td>34530</td>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021</td>
      <td>09.15</td>
      <td>16098</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>NaN</td>
      <td>5.0</td>
    </tr>
  </tbody>
</table>

关于时间序列的补齐，我的想法是城市列表与时间期限作笛卡尔积后，再连接原表。这样有记录时间的数据就会被填入，两次公告之间没有记录的数据留空。时间期限取所有数据记录中最早和最晚的两天。这时又发现一个小问题，出现了未来的数据（9-30），检查后发现是有些api返回数据的时间一直连续至未来，只是数值不变。过滤掉这部分假未来数据即可。

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>province</th>
      <th>city</th>
      <th>times</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-20</td>
    </tr>
    <tr>
      <th>1</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-21</td>
    </tr>
    <tr>
      <th>2</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-22</td>
    </tr>
    <tr>
      <th>3</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-24</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>267835</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-26</td>
    </tr>
    <tr>
      <th>267836</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-27</td>
    </tr>
    <tr>
      <th>267837</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-28</td>
    </tr>
    <tr>
      <th>267838</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-29</td>
    </tr>
    <tr>
      <th>267839</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-30</td>
    </tr>
  </tbody>
</table>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>province</th>
      <th>city</th>
      <th>realdate</th>
      <th>confirm</th>
      <th>dead</th>
      <th>heal</th>
      <th>suspect</th>
      <th>confirm_add</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-20</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-21</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-22</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>广东</td>
      <td>广州</td>
      <td>2020-01-24</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>267838</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-26</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>267839</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-27</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>267840</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-28</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>267841</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-29</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>267842</th>
      <td>台湾</td>
      <td>台湾</td>
      <td>2021-09-30</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>



接下来填补缺失值。重设index为['province','city','date']的组合，再以此index做groupby分组填补数据，不然会出现bfill中下一个城市的第一天填补上一个城市最后一天数据的情况。

先使用bfill填补"过去日期中有数据"的空缺，将这部分空缺视为"期间数据无变化"，取过去时间最新数据；然后再用fillna将剩下的缺失值填0,因为此时的缺失值在过去日期中没有数据，说明可能是最早还没有进行新冠疫情公告的时候，此时默认为0。

最后做一个自表连接，计算每日新增。新建一列'yesterday'为date-1天，然后使用'date'和'yesterday'做自连接，计算两天差异即可。

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>realdate_x</th>
      <th>confirm_x</th>
      <th>dead_x</th>
      <th>heal_x</th>
      <th>suspect_x</th>
      <th>yesterday_x</th>
      <th>realdate_y</th>
      <th>confirm_y</th>
      <th>dead_y</th>
      <th>heal_y</th>
      <th>suspect_y</th>
      <th>yesterday_y</th>
    </tr>
    <tr>
      <th>province</th>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">广东</th>
      <th>广州</th>
      <td>2020-01-20</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-19</td>
      <td>NaT</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaT</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-21</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-20</td>
      <td>2020-01-20</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-19</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-22</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-21</td>
      <td>2020-01-21</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-20</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-23</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-22</td>
      <td>2020-01-22</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-21</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-24</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-23</td>
      <td>2020-01-23</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020-01-22</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">台湾</th>
      <th>台湾</th>
      <td>2021-09-11</td>
      <td>16074.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-10</td>
      <td>2021-09-10</td>
      <td>16069.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-09</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-12</td>
      <td>16088.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-11</td>
      <td>2021-09-11</td>
      <td>16074.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-10</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-13</td>
      <td>16093.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-12</td>
      <td>2021-09-12</td>
      <td>16088.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-11</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-14</td>
      <td>16098.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-13</td>
      <td>2021-09-13</td>
      <td>16093.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-12</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-15</td>
      <td>16098.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-14</td>
      <td>2021-09-14</td>
      <td>16098.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>2021-09-13</td>
    </tr>
  </tbody>
</table>

最后去掉多余的列，调整列名。
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>realdate_x</th>
      <th>confirm_x</th>
      <th>dead_x</th>
      <th>heal_x</th>
      <th>suspect_x</th>
      <th>confirm_cal_add</th>
      <th>suspect_cal_add</th>
      <th>dead_cal_add</th>
      <th>heal_cal_add</th>
    </tr>
    <tr>
      <th>province</th>
      <th>city</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">广东</th>
      <th>广州</th>
      <td>2020-01-20</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-21</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-22</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-23</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>广州</th>
      <td>2020-01-24</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">台湾</th>
      <th>台湾</th>
      <td>2021-09-11</td>
      <td>16074.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-12</td>
      <td>16088.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-13</td>
      <td>16093.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-14</td>
      <td>16098.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>台湾</th>
      <td>2021-09-15</td>
      <td>16098.0</td>
      <td>839.0</td>
      <td>13742.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>

收工。

##  4. <a name='-1'></a>4.后续挖坑
- 可能会搭个云服务器和数据库，定期把数据导进去
- 可能会搭个前端页面做一下可视化